<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Consensus Agent Run Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f5f7;
      margin: 0;
      padding: 0 1rem;
    }
    .card {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
    }
    pre {
      background: #f2f2f2;
      padding: 1rem;
      overflow-x: auto;
      border-radius: 4px;
    }
    button {
      background-color: #4F46E5;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #4338ca;
    }
    .toggle {
      float: right;
    }
  </style>
</head>
<body>

  <h1>🧠 Consensus Agent Run Dashboard</h1>

  <div class="card">
    <h2>🎗️ Scheduled Goal</h2>
    <textarea id="goal" rows="3" style="width:100%" placeholder="Enter daily goal..."></textarea>
    <br><br>
    <button onclick="saveGoal()">📄 Save</button>
  </div>

  <div class="card">
    <h2>📄 Daily Digest</h2>
    <a href="/logs/daily_digest.txt" target="_blank">🖊️ View or download full digest</a>
    <pre id="digest">Loading...</pre>
  </div>

  <div class="card">
    <h2>🏋️ Agent Activity Chart</h2>
    <canvas id="chart" height="200"></canvas>
  </div>

  <div class="card">
    <h2>🔍 Memory Replay</h2>
    <select id="memory-select"></select>
    <pre id="memory-output">Select a memory file to view its content.</pre>
  </div>

  <div class="card">
    <h2>📃 Live Log Stream</h2>
    <pre id="log-output">Loading logs...</pre>
  </div>

<script>
// Goal load/save
function saveGoal() {
  const goal = document.getElementById('goal').value;
  fetch('/save-goal', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({goal})
  });
}
fetch('/goal')
  .then(res => res.text())
  .then(text => document.getElementById('goal').value = text)
  .catch(() => console.warn("Goal fetch failed"));

// Digest
fetch('/digest')
  .then(res => res.ok ? res.text() : Promise.reject())
  .then(text => document.getElementById('digest').textContent = text)
  .catch(() => document.getElementById('digest').textContent = 'No digest available.');

// Chart
fetch('/web/chart_data.json')
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(data => {
    const ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Agent Task Count',
          data: Object.values(data),
          backgroundColor: 'rgba(59, 130, 246, 0.5)'
        }]
      },
      options: {
        scales: {y: {beginAtZero: true}}
      }
    });
  });

// Memory Replay
fetch('/memory/list')
  .then(res => res.json())
  .then(files => {
    const select = document.getElementById('memory-select');
    files.forEach(f => {
      const opt = document.createElement('option');
      opt.value = f; opt.textContent = f;
      select.appendChild(opt);
    });
    select.addEventListener('change', () => {
      fetch(`/memory/view?file=${select.value}`)
        .then(r => r.text())
        .then(text => document.getElementById('memory-output').textContent = text);
    });
  });

// Log Stream (static fallback)
fetch('/logs/latest')
  .then(res => res.ok ? res.text() : Promise.reject())
  .then(text => document.getElementById('log-output').textContent = text)
  .catch(() => document.getElementById('log-output').textContent = 'No logs available.');
</script>

</body>
</html>
